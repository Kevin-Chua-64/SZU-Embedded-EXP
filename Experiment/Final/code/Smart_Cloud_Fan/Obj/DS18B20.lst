C51 COMPILER V9.02   DS18B20                                                               12/19/2022 09:56:57 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN ..\Obj\DS18B20.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE ..\Api\DS18B20.c BROWSE INCDIR(..\Api;..\Public;..\User) DEBUG OBJECTEXTEND
                    - PRINT(..\Obj\DS18B20.lst) OBJECT(..\Obj\DS18B20.obj)

line level    source

   1          #include "DS18B20.h"
   2          
   3          /*******************************
   4          reset the DS18B20 chip
   5          *******************************/
   6          void ds18b20_reset()
   7          {
   8   1              DS18B20_PORT=0; //拉低DQ
   9   1              delay_10us(75); //拉低750us
  10   1              DS18B20_PORT=1; //DQ=1
  11   1              delay_10us(2);  //20us
  12   1      }
  13          
  14          /*******************************
  15          check if DS18B20 chip exist(0) or not(1)
  16          *******************************/
  17          bit ds18b20_check()
  18          {
  19   1              unsigned char time_temp=0;
  20   1      
  21   1              while(DS18B20_PORT&&time_temp<20)       //等待DQ为低电平
  22   1              {
  23   2                      time_temp++;
  24   2                      delay_10us(1);  
  25   2              }
  26   1              if(time_temp>=20)return 1;      //如果超时则强制返回1
  27   1              else time_temp=0;
  28   1              while((!DS18B20_PORT)&&time_temp<20)    //等待DQ为高电平
  29   1              {
  30   2                      time_temp++;
  31   2                      delay_10us(1);
  32   2              }
  33   1              if(time_temp>=20)return 1;      //如果超时则强制返回1
  34   1              return 0;
  35   1      }
  36          
  37          /*******************************
  38          read one bit data from DS18B20 chip
  39          *******************************/
  40          bit ds18b20_read_bit()
  41          {
  42   1              bit dat=0;
  43   1              
  44   1              DS18B20_PORT=0;
  45   1              _nop_();_nop_();
  46   1              DS18B20_PORT=1; 
  47   1              _nop_();_nop_(); //该段时间不能过长，必须在15us内读取数据
  48   1              if(DS18B20_PORT) dat=1; //如果总线上为1则数据dat为1，否则为0
  49   1              else dat=0;
  50   1              delay_10us(5);
  51   1              return dat;
  52   1      } 
  53          
  54          /*******************************
C51 COMPILER V9.02   DS18B20                                                               12/19/2022 09:56:57 PAGE 2   

  55          read one byte data from DS18B20 chip
  56          *******************************/
  57          unsigned char ds18b20_read_byte()
  58          {
  59   1              unsigned char i=0;
  60   1              unsigned char dat=0;
  61   1              unsigned char temp=0;
  62   1      
  63   1              for(i=0;i<8;i++)//循环8次，每次读取一位，且先读低位再读高位
  64   1              {
  65   2                      temp=ds18b20_read_bit();
  66   2                      dat=(temp<<7)|(dat>>1);
  67   2              }
  68   1              return dat;     
  69   1      }
  70          
  71          /*******************************
  72          write one data data to DS18B20 chip
  73          *******************************/
  74          void ds18b20_write_byte(unsigned char dat)
  75          {
  76   1              unsigned char i=0;
  77   1              unsigned char temp=0;
  78   1      
  79   1              for(i=0;i<8;i++)//循环8次，每次写一位，且先写低位再写高位
  80   1              {
  81   2                      temp=dat&0x01;//选择低位准备写入
  82   2                      dat>>=1;//将次高位移到低位
  83   2                      if(temp)
  84   2                      {
  85   3                              DS18B20_PORT=0;
  86   3                              _nop_();_nop_();
  87   3                              DS18B20_PORT=1; 
  88   3                              delay_10us(6);
  89   3                      }
  90   2                      else
  91   2                      {
  92   3                              DS18B20_PORT=0;
  93   3                              delay_10us(6);
  94   3                              DS18B20_PORT=1;
  95   3                              _nop_();_nop_();        
  96   3                      }       
  97   2              }       
  98   1      }
  99          
 100          /*******************************
 101          prepare for starting
 102          *******************************/
 103          void ds18b20_start()
 104          {
 105   1              ds18b20_reset();//复位
 106   1              ds18b20_check();//检查DS18B20
 107   1              ds18b20_write_byte(0xcc);//SKIP ROM
 108   1          ds18b20_write_byte(0x44);//转换命令 
 109   1      }
 110          
 111          /*******************************
 112          reset and check 
 113          *******************************/
 114          bit ds18b20_init()
 115          {
 116   1              ds18b20_reset();
C51 COMPILER V9.02   DS18B20                                                               12/19/2022 09:56:57 PAGE 3   

 117   1              return ds18b20_check(); 
 118   1      }
 119          
 120          /*******************************
 121          read temperture from DS18B20 chip
 122          it takes a long time to excute and transfer data, so it is better to run this function in 1s interval
 123          type of return value: int, it is 10 times of the real temperature
 124          to avoid interruption affecting read and write bus timing, disable timer0 temporarily 
 125          *******************************/
 126          int ds18b20_read_temperture()
 127          {
 128   1              int cur_temp;
 129   1              unsigned char dath=0;
 130   1              unsigned char datl=0;
 131   1              unsigned int value=0;
 132   1      
 133   1              TR0 = 0;  // 避免中断影响读写总线时序，暂时不使能定时器0
 134   1      
 135   1              ds18b20_start();//开始转换
 136   1              ds18b20_reset();//复位
 137   1              ds18b20_check();
 138   1              ds18b20_write_byte(0xcc);//SKIP ROM
 139   1          ds18b20_write_byte(0xbe);//读存储器
 140   1      
 141   1              datl=ds18b20_read_byte();//低字节
 142   1              dath=ds18b20_read_byte();//高字节
 143   1              value=(dath<<8)+datl;//合并为16位数据
 144   1      
 145   1              if((value&0xf800)==0xf800)//判断符号位，负温度
 146   1              {
 147   2                      value=(~value)+1; //数据取反再加1
 148   2                      cur_temp=(value*(-5))/8;//乘以精度      
 149   2              }
 150   1              else //正温度
 151   1                      cur_temp=(value*5)/8;   
 152   1      
 153   1              TR0 = 1;  // 恢复定时器0
 154   1      
 155   1              return cur_temp;
 156   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    347    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
