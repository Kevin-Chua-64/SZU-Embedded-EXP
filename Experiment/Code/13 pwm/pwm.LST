C51 COMPILER V9.02   PWM                                                                   12/05/2022 23:10:45 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE PWM
OBJECT MODULE PLACED IN pwm.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE pwm.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg51.h>
   2          
   3          sbit PWM = P2^1;
   4          unsigned char g_tim_H, g_tim_L, g_tim_scale, g_duty;
   5          
   6          void delay_ms(unsigned char z)
   7          {
   8   1              unsigned char i, j;
   9   1              for(j=0;j<z;j++)
  10   1                      for(i=0;i<127;i++);
  11   1      }
  12          
  13          void pwm_init(unsigned char tim_H, unsigned char tim_L, unsigned char tim_scale, unsigned char duty)  //11
             -.0592MHz
  14          {
  15   1              g_tim_H = tim_H;
  16   1              g_tim_L = tim_L;
  17   1              g_tim_scale = tim_scale;
  18   1              g_duty = duty;
  19   1      
  20   1              TMOD &= 0xf0;
  21   1              TMOD |= 0x01;  // 计数器0工作在模式1
  22   1              TR0 = 1;  // 计数器0工作
  23   1              TH0 = tim_H;   
  24   1              TL0 = tim_L;
  25   1              EA = 1;
  26   1              ET0 = 1;  // 打开中断
  27   1      }
  28          
  29          void pwm_duty(unsigned duty)
  30          {
  31   1              g_duty = duty;
  32   1      }
  33          
  34          void main()
  35          {
  36   1              bit dic=0;
  37   1              unsigned char duty=0;
  38   1              unsigned char period = 100;
  39   1      
  40   1              pwm_init(0xff, 0xf0, period, 0);
  41   1      
  42   1              while (1)
  43   1              {
  44   2                      if (dic==0)
  45   2                      {
  46   3                              duty++;
  47   3                              if (duty>=period) dic = 1;
  48   3                      } else if (dic==1)
  49   2                      {
  50   3                              duty--;
  51   3                              if (duty<=0) dic = 0;
  52   3                      }       
  53   2                      pwm_duty(duty);
  54   2                      delay_ms(1);
C51 COMPILER V9.02   PWM                                                                   12/05/2022 23:10:45 PAGE 2   

  55   2              }
  56   1      }
  57          
  58          void pwm_interrupt() interrupt 1
  59          {
  60   1              static unsigned int cnt=0;
  61   1              
  62   1              cnt++;
  63   1              TH0 = g_tim_H;   
  64   1              TL0 = g_tim_L;
  65   1              if (cnt >= g_tim_scale) cnt = 0;  // 周期到了
  66   1              if (cnt <= g_duty) PWM = 1;
  67   1              else PWM = 0;
  68   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    159    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
