C51 COMPILER V9.02   MATRIX_KEY                                                            12/06/2022 00:07:43 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE MATRIX_KEY
OBJECT MODULE PLACED IN matrix_key.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE matrix_key.c BROWSE INCDIR(..\12 code_lock) DEBUG OBJECTEXTEND

line level    source

   1          #include "matrix_key.h"
   2          
   3          /*******************************
   4          函数名：matrix_key_scan
   5          函数功能：矩阵按键的扫描
   6          函数形参：void
   7          函数返回值：u8 
   8          备注：返回值为1~16，按列
   9          没有结果则返回0xff
  10          *******************************/
  11          unsigned char matrix_key_scan()
  12          {
  13   1              static unsigned char j=0;
  14   1              static unsigned char key_flag[4]={0x00,0x00,0x00,0x00};  // 四行，倒数第几位为0表示第几列按键没按下
  15   1              static unsigned char buff[4][4]={{0xff,0xff,0xff,0xff},{0xff,0xff,0xff,0xff},{0xff,0xff,0xff,0xff},{0xff,
             -0xff,0xff,0xff}};  // 消抖，连续采样8次，8次采样值均相同才视为稳定
  16   1              unsigned char i;
  17   1      
  18   1              switch(j)  // 换行扫描，对应行输入置0，低电平
  19   1              {
  20   2                      case 0: P1 = 0xf7; break;
  21   2                      case 1: P1 = 0xfb; break;
  22   2                      case 2: P1 = 0xfd; break;
  23   2                      case 3: P1 = 0xfe; break;
  24   2              }
  25   1      
  26   1              buff[j][0] = (buff[j][0]<<1) | matrix_k1;
  27   1              buff[j][1] = (buff[j][1]<<1) | matrix_k2;
  28   1              buff[j][2] = (buff[j][2]<<1) | matrix_k3;
  29   1              buff[j][3] = (buff[j][3]<<1) | matrix_k4;               
  30   1      
  31   1              for (i=0;i<4;i++)  //循环检测四个按键
  32   1              {
  33   2                      if ( ((key_flag[j]>>i)&0x01)==0x00 && buff[j][i]==0x00 )
  34   2                      {
  35   3                              key_flag[j] |= 0x01<<i;  // 置1，表示按键按下
  36   3                              return (4*j+i);
  37   3                      }
  38   2                      else if (buff[j][i]==0xff) key_flag[j] &= ~(0x01<<i);  // 置0，表示按键松开
  39   2              }
  40   1      
  41   1              j++;
  42   1              if (j==4) j = 0;
  43   1      
  44   1              return 0xff;  // 表示按键松开或者处于不稳定状态
  45   1      } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    276    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.02   MATRIX_KEY                                                            12/06/2022 00:07:43 PAGE 2   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
