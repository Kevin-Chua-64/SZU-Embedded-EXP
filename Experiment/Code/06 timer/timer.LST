C51 COMPILER V9.02   TIMER                                                                 10/31/2022 21:18:09 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN timer.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE timer.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg51.h>
   2          
   3          unsigned char code led_num[11] = {0x3f, 0x06, 0x5b, 0x4f, 0x66, 0x6d, 0x7d, 0x07, 0x7f, 0x6f, 0x40};
   4          unsigned char hour=0, min=0, sec=0;
   5          bit flag1=0, flag2=0;
   6          sbit LSA=P2^2;
   7          sbit LSB=P2^3;
   8          sbit LSC=P2^4;
   9          
  10          void delay(unsigned char z)      // delay z ms
  11          {
  12   1              unsigned char i, j;
  13   1              for(j=0;j<z;j++)
  14   1                      for(i=0;i<127;i++);
  15   1      }
  16          
  17          void timer0_config()  //11.0592MHz
  18          {
  19   1              TMOD &= 0xf0;
  20   1              TMOD |= 0x01;  // 计数器0工作在模式1
  21   1              TR0 = 1;  // 计数器0工作
  22   1              TH0 = 0xf8;   
  23   1              TL0 = 0xcd;  // 65536-63693=1843, 2ms
  24   1      }
  25          
  26          void timer1_config()  //11.0592MHz
  27          {
  28   1              TMOD &= 0x0f;
  29   1              TMOD |= 0x10;  // 计数器1工作在模式1
  30   1              TR1 = 1;  // 计数器1工作
  31   1              TH1 = 0xdc;   
  32   1              TL1 = 0x00;  // 65536-56320=9216, 10ms
  33   1      }
  34                  
  35          void count()
  36          {
  37   1              if (flag2==1)
  38   1              {
  39   2                      flag2 = 0;
  40   2                      sec++;
  41   2                      if (sec==60)
  42   2                      {
  43   3                              sec = 0;
  44   3                              min++;
  45   3                              if (min==60)
  46   3                              {
  47   4                                      min = 0;
  48   4                                      hour++;
  49   4                                      if (hour==24) hour = 0; 
  50   4                              }
  51   3                      }
  52   2              }               
  53   1      }
  54                                           
  55          void display()
C51 COMPILER V9.02   TIMER                                                                 10/31/2022 21:18:09 PAGE 2   

  56          {
  57   1              static unsigned char i=0;
  58   1      
  59   1              switch(i)  // 位选
  60   1              {
  61   2                      case 0: LSC=1;LSB=1;LSA=1;P0 = led_num[hour/10]; break;
  62   2                      case 1: LSC=1;LSB=1;LSA=0;P0 = led_num[hour%10]; break;
  63   2                      case 2: LSC=1;LSB=0;LSA=1;P0 = led_num[10]; break;
  64   2                      case 3: LSC=1;LSB=0;LSA=0;P0 = led_num[min/10]; break;
  65   2                      case 4: LSC=0;LSB=1;LSA=1;P0 = led_num[min%10]; break;
  66   2                      case 5: LSC=0;LSB=1;LSA=0;P0 = led_num[10]; break;
  67   2                      case 6: LSC=0;LSB=0;LSA=1;P0 = led_num[sec/10]; break;
  68   2                      case 7: LSC=0;LSB=0;LSA=0;P0 = led_num[sec%10]; break;
  69   2              }
  70   1      
  71   1              delay(2);
  72   1              P0=0x00;  // 消音
  73   1              i++;
  74   1              if (i==8) i=0;
  75   1      }
  76          
  77          void led_running()
  78          {
  79   1              static unsigned char i=0;  // 除掉2345
  80   1      
  81   1              P2 = (0xfe<<i)|(0xfe>>(8-i));
  82   1      
  83   1              if (flag1==1)
  84   1              {
  85   2                      flag1 = 0;
  86   2                      i++;
  87   2                      if (i==2) i=6;
  88   2                      if (i==8) i=0;
  89   2              }
  90   1      }
  91          
  92          void main()
  93          {       
  94   1              EA = 1; // 中断总开关
  95   1              ET0 = 1;  // 定时器0中断分开关
  96   1              ET1 = 1;  // 定时器1中断分开关
  97   1              timer0_config();
  98   1              timer1_config();
  99   1              while(1)
 100   1              {
 101   2                      count();
 102   2                      display();
 103   2                      if (min==0) led_running(); else P2 = 0xff;       // 1分钟时启动流水灯，2分钟关闭
 104   2              }               
 105   1      }
 106          
 107          void led_200ms() interrupt 1
 108          {
 109   1              static unsigned char cnt=0;
 110   1              
 111   1              cnt++;
 112   1              TH0 = 0xf8;   
 113   1              TL0 = 0xcd;
 114   1              if (cnt==100)
 115   1              {
 116   2                      cnt = 0;
 117   2                      flag1 = 1;
C51 COMPILER V9.02   TIMER                                                                 10/31/2022 21:18:09 PAGE 3   

 118   2              }
 119   1      }
 120          
 121          void count_1s() interrupt 3
 122          {
 123   1              static unsigned char cnt=0;
 124   1              
 125   1              cnt++;
 126   1              TH1 = 0xdc;   
 127   1              TL1 = 0x00;
 128   1              if (cnt==100)
 129   1              {
 130   2                      cnt = 0;
 131   2                      flag2 = 1;
 132   2              }
 133   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    384    ----
   CONSTANT SIZE    =     11    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
