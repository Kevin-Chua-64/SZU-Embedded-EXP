C51 COMPILER V9.02   DS18B20                                                               12/16/2022 23:19:35 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN ..\Obj\DS18B20.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE ..\Api\DS18B20.c BROWSE INCDIR(..\Api;..\Public;..\User) DEBUG OBJECTEXTEND
                    - PRINT(..\Obj\DS18B20.lst) OBJECT(..\Obj\DS18B20.obj)

line level    source

   1          #include "DS18B20.h"
   2          
   3          /*******************************
   4          函数名：ds18b20_reset
   5          函数功能：复位
   6          函数形参：void
   7          函数返回值：void 
   8          备注：
   9          *******************************/
  10          void ds18b20_reset()
  11          {
  12   1              DS18B20_PORT=0; //拉低DQ
  13   1              delay_10us(75); //拉低750us
  14   1              DS18B20_PORT=1; //DQ=1
  15   1              delay_10us(2);  //20us
  16   1      }
  17          
  18          /*******************************
  19          函数名：ds18b20_check
  20          函数功能：检测DS18B20是否存在
  21          函数形参：void
  22          函数返回值：bit
  23          备注：1:未检测到DS18B20的存在，0:存在
  24          *******************************/
  25          bit ds18b20_check()
  26          {
  27   1              unsigned char time_temp=0;
  28   1      
  29   1              while(DS18B20_PORT&&time_temp<20)       //等待DQ为低电平
  30   1              {
  31   2                      time_temp++;
  32   2                      delay_10us(1);  
  33   2              }
  34   1              if(time_temp>=20)return 1;      //如果超时则强制返回1
  35   1              else time_temp=0;
  36   1              while((!DS18B20_PORT)&&time_temp<20)    //等待DQ为高电平
  37   1              {
  38   2                      time_temp++;
  39   2                      delay_10us(1);
  40   2              }
  41   1              if(time_temp>=20)return 1;      //如果超时则强制返回1
  42   1              return 0;
  43   1      }
  44          
  45          /*******************************
  46          函数名：ds18b20_read_bit
  47          函数功能：读取一个bit
  48          函数形参：void
  49          函数返回值：bit 
  50          备注：
  51          *******************************/
  52          bit ds18b20_read_bit()
  53          {
  54   1              bit dat=0;
C51 COMPILER V9.02   DS18B20                                                               12/16/2022 23:19:35 PAGE 2   

  55   1              
  56   1              DS18B20_PORT=0;
  57   1              _nop_();_nop_();
  58   1              DS18B20_PORT=1; 
  59   1              _nop_();_nop_(); //该段时间不能过长，必须在15us内读取数据
  60   1              if(DS18B20_PORT) dat=1; //如果总线上为1则数据dat为1，否则为0
  61   1              else dat=0;
  62   1              delay_10us(5);
  63   1              return dat;
  64   1      } 
  65          
  66          /*******************************
  67          函数名：ds18b20_read_byte
  68          函数功能：读取一个byte
  69          函数形参：void
  70          函数返回值：unsigned char 
  71          备注：
  72          *******************************/
  73          unsigned char ds18b20_read_byte()
  74          {
  75   1              unsigned char i=0;
  76   1              unsigned char dat=0;
  77   1              unsigned char temp=0;
  78   1      
  79   1              for(i=0;i<8;i++)//循环8次，每次读取一位，且先读低位再读高位
  80   1              {
  81   2                      temp=ds18b20_read_bit();
  82   2                      dat=(temp<<7)|(dat>>1);
  83   2              }
  84   1              return dat;     
  85   1      }
  86          
  87          /*******************************
  88          函数名：ds18b20_write_byte
  89          函数功能：写入一个byte
  90          函数形参：u8 dat
  91          函数返回值：void
  92          备注：
  93          *******************************/
  94          void ds18b20_write_byte(unsigned char dat)
  95          {
  96   1              unsigned char i=0;
  97   1              unsigned char temp=0;
  98   1      
  99   1              for(i=0;i<8;i++)//循环8次，每次写一位，且先写低位再写高位
 100   1              {
 101   2                      temp=dat&0x01;//选择低位准备写入
 102   2                      dat>>=1;//将次高位移到低位
 103   2                      if(temp)
 104   2                      {
 105   3                              DS18B20_PORT=0;
 106   3                              _nop_();_nop_();
 107   3                              DS18B20_PORT=1; 
 108   3                              delay_10us(6);
 109   3                      }
 110   2                      else
 111   2                      {
 112   3                              DS18B20_PORT=0;
 113   3                              delay_10us(6);
 114   3                              DS18B20_PORT=1;
 115   3                              _nop_();_nop_();        
 116   3                      }       
C51 COMPILER V9.02   DS18B20                                                               12/16/2022 23:19:35 PAGE 3   

 117   2              }       
 118   1      }
 119          
 120          /*******************************
 121          函数名：ds18b20_start
 122          函数功能：温度转换
 123          函数形参：void
 124          函数返回值：void
 125          备注：
 126          *******************************/
 127          void ds18b20_start()
 128          {
 129   1              ds18b20_reset();//复位
 130   1              ds18b20_check();//检查DS18B20
 131   1              ds18b20_write_byte(0xcc);//SKIP ROM
 132   1          ds18b20_write_byte(0x44);//转换命令 
 133   1      }
 134          
 135          /*******************************
 136          函数名：ds18b20_init
 137          函数功能：初始化DS18B20并检测是否存在
 138          函数形参：void
 139          函数返回值：bit
 140          备注：1:未检测到DS18B20的存在，0:存在
 141          *******************************/
 142          bit ds18b20_init()
 143          {
 144   1              ds18b20_reset();
 145   1              return ds18b20_check(); 
 146   1      }
 147          
 148          /*******************************
 149          函数名：ds18b20_read_temperture
 150          函数功能：获取温度值
 151          函数形参：void
 152          函数返回值：float
 153          备注：获取值为浮点数，运行一次时间较久，因此间隔一段时间读取(1s)
 154          *******************************/
 155          float ds18b20_read_temperture()
 156          {
 157   1              xdata float temp;
 158   1              xdata unsigned char dath=0;
 159   1              xdata unsigned char datl=0;
 160   1              xdata unsigned int value=0;
 161   1      
 162   1              ds18b20_start();//开始转换
 163   1              ds18b20_reset();//复位
 164   1              ds18b20_check();
 165   1              ds18b20_write_byte(0xcc);//SKIP ROM
 166   1          ds18b20_write_byte(0xbe);//读存储器
 167   1      
 168   1              datl=ds18b20_read_byte();//低字节
 169   1              dath=ds18b20_read_byte();//高字节
 170   1              value=(dath<<8)+datl;//合并为16位数据
 171   1      
 172   1              if((value&0xf800)==0xf800)//判断符号位，负温度
 173   1              {
 174   2                      value=(~value)+1; //数据取反再加1
 175   2                      temp=value*(-0.0625);//乘以精度 
 176   2              }
 177   1              else //正温度
 178   1              {
C51 COMPILER V9.02   DS18B20                                                               12/16/2022 23:19:35 PAGE 4   

 179   2                      temp=value*0.0625;      
 180   2              }
 181   1              return temp;
 182   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    393    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       8
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
